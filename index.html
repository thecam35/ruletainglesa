<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta Rusa de Premios</title>
<!-- Agregar Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<!-- Fuentes más convencionales -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Roboto', 'Arial', sans-serif;
        text-align: center;
        background: #f5f5f5;
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        min-height: 100vh;
    }
    h1 {
        margin-top: 20px;
        color: #2c3e50;
        font-weight: 700;
    }
    canvas {
        background: #fff;
        border-radius: 50%;
        margin-top: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border: 2px solid #3498db;
    }
    button {
        background: #3498db;
        border: none;
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
        margin: 10px;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    button:hover {
        background: #2980b9;
        transform: translateY(-2px);
    }
    #resultado {
        font-size: 20px;
        margin-top: 20px;
        font-weight: bold;
        color: #2c3e50;
    }
    #total {
        font-size: 18px;
        margin-top: 10px;
        color: #27ae60;
    }
    .auth-container {
        max-width: 400px;
        margin: 20px auto;
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .auth-form input {
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background: #fff;
        color: #333;
        font-size: 16px;
    }
    .auth-form button {
        margin: 0;
    }
    .hidden {
        display: none;
    }
    #userInfo {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #logoutBtn {
        background: #e74c3c;
        padding: 5px 15px;
        font-size: 14px;
        margin-left: 10px;
    }
    #logoutBtn:hover {
        background: #c0392b;
    }
    /* Estilos para el modal de reglas */
    .rules-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    .rules-btn:hover {
        transform: scale(1.1);
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 25px;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        text-align: left;
    }
    .close {
        color: #7f8c8d;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover {
        color: #333;
    }
    .rules-title {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
        font-size: 22px;
    }
    .rules-list {
        padding-left: 20px;
    }
    .rules-list li {
        margin-bottom: 15px;
        line-height: 1.6;
    }
    .highlight {
        color: #e74c3c;
        font-weight: bold;
    }
    /* Panel lateral de retiros y recargas */
    .side-panel {
        width: 350px;
        background: white;
        padding: 20px;
        overflow-y: auto;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
    }
    .panel-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
    }
    .panel-tab {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: #7f8c8d;
        transition: all 0.3s ease;
    }
    .panel-tab.active {
        border-bottom: 3px solid #3498db;
        color: #3498db;
        font-weight: bold;
    }
    .panel-tab:hover {
        color: #3498db;
    }
    .panel-content {
        flex: 1;
        overflow-y: auto;
    }
    .panel-title {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 20px;
        text-align: center;
    }
    .item {
        background: #f9f9f9;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        position: relative;
        border: 1px solid #eee;
        transition: all 0.3s ease;
    }
    .item:hover {
        transform: translateY(-3px);
    }
    .item-name {
        font-weight: bold;
        color: #2c3e50;
    }
    .item-amount {
        color: #27ae60;
    }
    .item-status {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 15px;
        font-weight: bold;
    }
    .status-pending {
        background: #f39c12;
        color: white;
    }
    .status-approved {
        background: #27ae60;
        color: white;
    }
    .status-rejected {
        background: #e74c3c;
        color: white;
    }
    .item-date {
        font-size: 12px;
        color: #95a5a6;
        margin-top: 8px;
    }
    /* Contenedor principal del juego */
    .main-container {
        flex: 1;
        padding: 30px;
        position: relative;
    }
    /* Panel de administración */
    .admin-btn {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: #9b59b6;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    .admin-btn:hover {
        transform: scale(1.1);
    }
    .admin-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 1002;
        overflow-y: auto;
        padding: 30px;
    }
    .admin-panel h2 {
        color: #9b59b6;
        text-align: center;
        font-size: 24px;
        margin-bottom: 30px;
    }
    .admin-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    .admin-tab {
        padding: 10px 20px;
        background: #2c3e50;
        margin: 0 10px;
        cursor: pointer;
        border-radius: 4px;
        color: white;
        transition: all 0.3s ease;
    }
    .admin-tab.active {
        background: #9b59b6;
        color: white;
        font-weight: bold;
    }
    .admin-tab:hover {
        background: #8e44ad;
    }
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
    }
    .admin-table th, .admin-table td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .admin-table th {
        background: #f2f2f2;
        color: #2c3e50;
    }
    .admin-table tr:nth-child(even) {
        background: #f9f9f9;
    }
    .admin-table tr:hover {
        background: #f1f1f1;
    }
    .admin-action-btn {
        padding: 6px 12px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    .approve-btn {
        background: #27ae60;
        color: white;
    }
    .approve-btn:hover {
        background: #2ecc71;
    }
    .reject-btn {
        background: #e74c3c;
        color: white;
    }
    .reject-btn:hover {
        background: #c0392b;
    }
    /* Formulario de retiro */
    .withdraw-form {
        max-width: 450px;
        margin: 30px auto;
        padding: 30px;
        background: white;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .withdraw-form input {
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
        border: 1px solid #ddd;
        background: #fff;
        color: #333;
        font-size: 16px;
    }
    .empty-message {
        text-align: center;
        color: #95a5a6;
        font-style: italic;
        margin-top: 30px;
        font-size: 16px;
    }
    /* Modal de recarga */
    .recharge-modal {
        display: none;
        position: fixed;
        z-index: 1003;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .recharge-content {
        background: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
        text-align: center;
    }
    .recharge-title {
        color: #2c3e50;
        font-size: 22px;
        margin-bottom: 20px;
    }
    .recharge-info {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .recharge-info p {
        margin: 10px 0;
    }
    .recharge-amount {
        font-size: 18px;
        font-weight: bold;
        color: #27ae60;
    }
    .recharge-id {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
        margin: 15px 0;
        padding: 10px;
        background: #f2f2f2;
        border-radius: 4px;
    }
    .recharge-steps {
        text-align: left;
        margin: 20px 0;
    }
    .recharge-steps li {
        margin-bottom: 10px;
    }
    /* Estilos para el panel de referidos */
    .referral-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: left;
    }
    .referral-title {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        text-align: center;
    }
    .referral-code {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 18px;
        text-align: center;
        margin: 10px 0;
        border: 1px dashed #3498db;
    }
    .referral-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    .stat-box {
        background: #f1f8fe;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        flex: 1;
        margin: 0 5px;
        border: 1px solid #e1f0fa;
    }
    .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #3498db;
    }
    .stat-label {
        font-size: 12px;
        color: #7f8c8d;
    }
    .referral-list {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 15px;
    }
    .referral-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
    }
    .referral-item:last-child {
        border-bottom: none;
    }
    .copy-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
    }
    .copy-btn:hover {
        background: #2980b9;
    }
    .share-buttons {
        display: flex;
        justify-content: center;
        margin-top: 15px;
        gap: 10px;
    }
    .share-btn {
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .whatsapp-btn {
        background: #25D366;
        color: white;
    }
    .telegram-btn {
        background: #0088cc;
        color: white;
    }
    .facebook-btn {
        background: #3b5998;
        color: white;
    }
</style>
</head>
<body>

<!-- Panel lateral de retiros y recargas -->
<div class="side-panel">
    <div class="panel-tabs">
        <div class="panel-tab active" onclick="showPanelTab('withdrawals')">Retiros</div>
        <div class="panel-tab" onclick="showPanelTab('recharges')">Recargas</div>
        <div class="panel-tab" onclick="showPanelTab('myWithdrawals')">Mis Retiros</div>
        <div class="panel-tab" onclick="showPanelTab('referrals')">Referidos</div>
    </div>
    
    <div class="panel-content">
        <div id="withdrawalsPanel">
            <div class="panel-title">📋 Últimos Retiros</div>
            <div id="withdrawalsList"></div>
        </div>
        
        <div id="rechargesPanel" style="display: none;">
            <div class="panel-title">💳 Historial de Recargas</div>
            <div id="rechargesList"></div>
        </div>
        
        <div id="myWithdrawalsPanel" style="display: none;">
            <div class="panel-title">📋 Mis Retiros</div>
            <div id="myWithdrawalsList"></div>
        </div>
        
        <div id="referralsPanel" style="display: none;">
            <div class="panel-title">👥 Programa de Referidos</div>
            <div class="referral-panel">
                <div class="referral-title">Invita amigos y gana $1 USD por cada uno</div>
                
                <div>Tu enlace de referido:</div>
                <div class="referral-code" id="referralLink">Cargando...</div>
                <button class="copy-btn" onclick="copyReferralLink()">Copiar</button>
                
                <div class="share-buttons">
                    <button class="share-btn whatsapp-btn" onclick="shareViaWhatsApp()">
                        <i>📱</i> WhatsApp
                    </button>
                    <button class="share-btn telegram-btn" onclick="shareViaTelegram()">
                        <i>✈️</i> Telegram
                    </button>
                    <button class="share-btn facebook-btn" onclick="shareViaFacebook()">
                        <i>👍</i> Facebook
                    </button>
                </div>
                
                <div class="referral-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Referidos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeReferrals">0</div>
                        <div class="stat-label">Activos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="referralEarnings">$0.00</div>
                        <div class="stat-label">Ganancias</div>
                    </div>
                </div>
                
                <div class="referral-title">Tus referidos</div>
                <div class="referral-list" id="referralList">
                    <div class="empty-message"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor principal -->
<div class="main-container">
    <!-- Botón para abrir reglas -->
    <button class="rules-btn" onclick="openRules()">📜</button>

    <!-- Botón para panel de admin -->
    <button id="adminBtn" class="admin-btn hidden" onclick="openAdminPanel()">👑</button>

    <!-- Modal de reglas -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRules()">&times;</span>
            <h2 class="rules-title">🎯 Reglas Oficiales de la Ruleta Rusa de Premios 🎯</h2>
            <ul class="rules-list">
                <li>💰 Cada giro tiene un costo de <span class="highlight">$1 USD</span>.</li>
                <li>💳 La recarga mínima es de <span class="highlight">$1 USD</span>.</li>
                <li>🚫 No se aceptan recargas menores a $1 USD.</li>
                <li>🏦 El requisito mínimo para retirar es de <span class="highlight">$30 USD</span>.</li>
                <li>⚠️ <span class="highlight">IMPORTANTE:</span> Para poder retirar $30 USD, debes haber recargado al menos $1 USD adicional cuando tu saldo alcance $29 USD.</li>
                <li>❌ Si recargas $1 USD y con ese dolar logras llegar a $29 USD, y luego recargas otro $1 USD para intentar retirar $30 USD, <span class="highlight">NO será válido</span>.</li>
                <li>🔒 El saldo acumulado debe provenir mayormente de tus recargas, no solo de ganancias.</li>
                <li>🔄 Puedes girar tantas veces como tu saldo lo permita.</li>
                <li>🎁 Los premios van desde $0.50 USD hasta $10.00 USD, pero también hay espacios vacíos.</li>
                <li>📌 Para recargar, envía el pago al ID de Binance: <span class="highlight">357239258</span>.</li>
                <li>👥 <span class="highlight">NUEVO:</span> Invita amigos con tu código de referido y gana $1 USD por cada uno que se registre.</li>
            </ul>
        </div>
    </div>

    <!-- Modal de recarga -->
    <div id="rechargeModal" class="recharge-modal">
        <div class="recharge-content">
            <span class="close" onclick="closeRechargeModal()">&times;</span>
            <h2 class="recharge-title">💳 Recargar Saldo</h2>
            
            <div class="recharge-info">
                <p>Para recargar tu saldo, sigue estos pasos:</p>
                
                <div class="recharge-steps">
                    <ol>
                        <li>Abre tu aplicación de Binance</li>
                        <li>Selecciona la opción de enviar cripto</li>
                        <li>Ingresa el siguiente ID de Binance:</li>
                    </ol>
                </div>
                
                <div class="recharge-id">357239258</div>
                
                <p>Envía el monto que deseas recargar (mínimo $1 USD)</p>
                <p>Luego completa el siguiente formulario:</p>
            </div>
            
            <input type="number" id="rechargeAmount" placeholder="Monto a recargar (USD)" min="1" step="0.01">
            <button onclick="submitRechargeRequest()">Enviar Solicitud</button>
            <button onclick="closeRechargeModal()" style="background: #e74c3c;">Cancelar</button>
        </div>
    </div>

    <!-- Panel de administración -->
    <div id="adminPanel" class="admin-panel">
        <h2>👑 Panel de Administración</h2>
        
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="showAdminTab('recharges')">Recargas Pendientes</div>
            <div class="admin-tab" onclick="showAdminTab('withdrawals')">Retiros Pendientes</div>
            <div class="admin-tab" onclick="showAdminTab('users')">Usuarios</div>
        </div>
        
        <div id="rechargesTab">
            <h3>Recargas Pendientes de Aprobación</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Monto</th>
                        <th>ID Binance</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="pendingRecharges">
                    <!-- Datos de recargas pendientes -->
                </tbody>
            </table>
        </div>
        
        <div id="withdrawalsTab" style="display: none;">
            <h3>Retiros Pendientes de Aprobación</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Monto</th>
                        <th>ID Binance</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="pendingWithdrawals">
                    <!-- Datos de retiros pendientes -->
                </tbody>
            </table>
        </div>
        
        <div id="usersTab" style="display: none;">
            <h3>Usuarios Registrados</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Saldo</th>
                        <th>Recargas</th>
                        <th>Retiros</th>
                        <th>Referidos</th>
                        <th>Registro</th>
                        <th>ID Binance</th>
                    </tr>
                </thead>
                <tbody id="usersList">
                    <!-- Lista de usuarios -->
                </tbody>
            </table>
        </div>
        
        <button onclick="closeAdminPanel()" style="margin-top: 20px; background: #e74c3c;">Cerrar Panel</button>
    </div>

    <!-- Contenedor de autenticación -->
    <div id="authContainer" class="auth-container">
        <h2>Iniciar Sesión / Registrarse</h2>
        <div class="auth-form">
            <input type="email" id="email" placeholder="Correo electrónico">
            <input type="password" id="password" placeholder="Contraseña">
            <input type="text" id="binanceIdRegister" placeholder="ID de Binance (requerido)" class="hidden">
            <input type="text" id="referralCode" placeholder="Código de referido (opcional)" class="hidden">
            <button onclick="login()">Iniciar Sesión</button>
            <button onclick="toggleRegister()">Registrarse</button>
        </div>
    </div>

    <!-- Información del usuario -->
    <div id="userInfo" class="hidden">
        <span id="userEmail"></span>
        <button id="logoutBtn" onclick="logout()">Cerrar Sesión</button>
    </div>

    <!-- Contenido principal (oculto hasta autenticación) -->
    <div id="gameContainer" class="hidden">
        <h1> Ruleta Rusa de Premios </h1>
        <canvas id="ruleta" width="400" height="400"></canvas>
        <br>
        <button onclick="girar()">🎡 Girar (Costo: $1 USD)</button>
        <button onclick="openRechargeModal()">💳 Recargar Saldo</button>
        <button onclick="openWithdrawForm()">💸 Solicitar Retiro</button>

        <p id="resultado"></p>
        <p id="total">💵 Total ganado: $0.00 USD</p>
    </div>

    <!-- Formulario de retiro -->
    <div id="withdrawForm" class="withdraw-form hidden">
        <h3>💸 Solicitar Retiro</h3>
        <p id="withdrawMessage"></p>
        <input type="number" id="withdrawAmount" placeholder="Monto a retirar" min="30" step="0.01" required>
        <button onclick="requestWithdrawal()">Enviar Solicitud</button>
        <button onclick="closeWithdrawForm()" style="background: #e74c3c;">Cancelar</button>
    </div>
</div>

<script>
// Configuración de Firebase
const firebaseConfig = { 
    apiKey: "AIzaSyD1CCs4Pc5DbZygvJfxmYkSvAV3pnkqnEQ", 
    authDomain: "inversiones-6c2c6.firebaseapp.com", 
    projectId: "inversiones-6c2c6", 
    storageBucket: "inversiones-6c2c6.appspot.com", 
    messagingSenderId: "581876411327", 
    appId: "1:581876411327:web:1d1ddb1fcdd625938f4f0a", 
    measurementId: "G-4BG5ME7TCH" 
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Configuración del bot de Telegram
const TELEGRAM_BOT_TOKEN = 'TU_TOKEN_DE_BOT_TELEGRAM'; // Reemplazar con tu token
const TELEGRAM_CHAT_ID = 'TU_CHAT_ID'; // Reemplazar con tu chat ID o grupo ID

// Función para enviar notificaciones a Telegram
async function sendTelegramNotification(message) {
    try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            })
        });
        
        const data = await response.json();
        if (!data.ok) {
            console.error('Error al enviar notificación a Telegram:', data);
        }
    } catch (error) {
        console.error('Error al enviar notificación a Telegram:', error);
    }
}

// Variables del juego
const canvas = document.getElementById("ruleta");
const ctx = canvas.getContext("2d");

// Modificado: ahora hay 10 premios y 10 "Nada"
const premios = [
    "$0.50", "Nada", "$1.25", "Nada", "$2.75", "Nada", "$4.50", "Nada", 
    "$5.25", "Nada", "$6.00", "Nada", "$7.10", "Nada", "$9.75", "Nada", 
    "$1.50", "Nada", "$2.00", "Nada"
];

const colores = [
    "#e74c3c", "#95a5a6", "#2ecc71", "#95a5a6", "#3498db", "#95a5a6",
    "#9b59b6", "#95a5a6", "#1abc9c", "#95a5a6", "#27ae60", "#95a5a6",
    "#2980b9", "#95a5a6", "#f1c40f", "#95a5a6", "#e67e22", "#95a5a6",
    "#e74c3c", "#95a5a6"
];

let anguloInicio = 0;
const arc = Math.PI * 2 / premios.length;
let girando = false;
let velocidad = 0;
let frenado = 0.985;
let totalGanado = 0;
let userId = null;
let isAdmin = false;
let registering = false;
let referralCode = '';
let referralLink = '';

// Lista de nombres para el panel lateral
const nombres = ["Juan", "Luis", "Carlos", "María", "Ana", "Pedro", "José", "Miguel", "Sofía", "Laura"];

// Lista de montos para el panel lateral
const montos = [30.50, 45.75, 60.00, 35.25, 50.50, 65.75, 40.00, 55.25, 70.50, 85.75];

// Funciones para el panel lateral
function showPanelTab(tabName) {
    document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.panel-tab[onclick="showPanelTab('${tabName}')"]`).classList.add('active');
    
    document.getElementById('withdrawalsPanel').style.display = 'none';
    document.getElementById('rechargesPanel').style.display = 'none';
    document.getElementById('myWithdrawalsPanel').style.display = 'none';
    document.getElementById('referralsPanel').style.display = 'none';
    
    document.getElementById(`${tabName}Panel`).style.display = 'block';
    
    // Si es la pestaña de mis retiros, cargarlos
    if (tabName === 'myWithdrawals' && userId) {
        loadMyWithdrawals();
    }
    
    // Si es la pestaña de referidos, cargarlos
    if (tabName === 'referrals' && userId) {
        loadReferralData();
    }
}

function generateRandomWithdrawals() {
    const withdrawalsList = document.getElementById('withdrawalsList');
    withdrawalsList.innerHTML = '';
    
    for (let i = 0; i < 10; i++) {
        const randomName = nombres[Math.floor(Math.random() * nombres.length)];
        const randomAmount = montos[Math.floor(Math.random() * montos.length)];
        const randomStatus = Math.random() > 0.3 ? 'approved' : (Math.random() > 0.5 ? 'pending' : 'rejected');
        
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
            <div class="item-name">${randomName}</div>
            <div class="item-amount">Retiró $${randomAmount.toFixed(2)} USD</div>
            <div class="item-status status-${randomStatus}">
                ${randomStatus === 'approved' ? 'Aprobado' : randomStatus === 'pending' ? 'Pendiente' : 'Rechazado'}
            </div>
            <div class="item-date">Hace ${Math.floor(Math.random() * 24) + 1} horas</div>
        `;
        withdrawalsList.appendChild(item);
    }
}

function generateRandomRecharges() {
    const rechargesList = document.getElementById('rechargesList');
    rechargesList.innerHTML = '';
    
    for (let i = 0; i < 10; i++) {
        const randomName = nombres[Math.floor(Math.random() * nombres.length)];
        const randomAmount = montos[Math.floor(Math.random() * 5) + 1];
        const randomStatus = Math.random() > 0.3 ? 'approved' : (Math.random() > 0.5 ? 'pending' : 'rejected');
        
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
            <div class="item-name">${randomName}</div>
            <div class="item-amount">Recargó $${randomAmount.toFixed(2)} USD</div>
            <div class="item-status status-${randomStatus}">
                ${randomStatus === 'approved' ? 'Aprobado' : randomStatus === 'pending' ? 'Pendiente' : 'Rechazado'}
            </div>
            <div class="item-date">Hace ${Math.floor(Math.random() * 24) + 1} horas</div>
        `;
        rechargesList.appendChild(item);
    }
}

// Función para cargar los retiros del usuario actual
function loadMyWithdrawals() {
    if (!userId) return;
    
    const myWithdrawalsList = document.getElementById('myWithdrawalsList');
    myWithdrawalsList.innerHTML = '<div class="empty-message">Cargando tus retiros...</div>';
    
    db.collection('withdrawalRequests')
        .where('userId', '==', userId)
        .orderBy('timestamp', 'desc')
        .get()
        .then(querySnapshot => {
            if (querySnapshot.empty) {
                myWithdrawalsList.innerHTML = '<div class="empty-message">No has realizado ningún retiro aún</div>';
                return;
            }
            
            myWithdrawalsList.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <div class="item-amount">$${data.amount.toFixed(2)} USD</div>
                    <div class="item-status status-${data.status}">
                        ${data.status === 'approved' ? 'Aprobado' : data.status === 'pending' ? 'Pendiente' : 'Rechazado'}
                    </div>
                    <div class="item-date">${new Date(data.timestamp?.toDate()).toLocaleString()}</div>
                    ${data.processedAt ? `<div class="item-date">Procesado: ${new Date(data.processedAt?.toDate()).toLocaleString()}</div>` : ''}
                    ${data.processedBy ? `<div class="item-date">Por: ${data.processedBy}</div>` : ''}
                `;
                myWithdrawalsList.appendChild(item);
            });
        })
        .catch(error => {
            console.error("Error cargando retiros del usuario:", error);
            myWithdrawalsList.innerHTML = '<div class="empty-message">Error al cargar tus retiros</div>';
        });
}

// Funciones para el modal de reglas
function openRules() {
    document.getElementById('rulesModal').style.display = 'block';
}

function closeRules() {
    document.getElementById('rulesModal').style.display = 'none';
}

// Funciones para el modal de recarga
function openRechargeModal() {
    document.getElementById('rechargeModal').style.display = 'block';
}

function closeRechargeModal() {
    document.getElementById('rechargeModal').style.display = 'none';
}

function submitRechargeRequest() {
    const monto = parseFloat(document.getElementById('rechargeAmount').value);
    
    if (isNaN(monto)) {
        alert("Por favor ingresa un monto válido.");
        return;
    }
    if (monto < 1) {
        alert("El monto mínimo de recarga es $1 USD.");
        return;
    }
    
    const user = auth.currentUser;
    
    // Crear solicitud de recarga
    db.collection('rechargeRequests').add({
        userId: user.uid,
        userName: user.displayName || user.email.split('@')[0],
        userEmail: user.email,
        amount: monto,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        // Notificación a Telegram
        const telegramMsg = `🆕 <b>NUEVA SOLICITUD DE RECARGA</b>\n\n` +
                           `👤 Usuario: ${user.email}\n` +
                           `💰 Monto: $${monto.toFixed(2)} USD\n` +
                           `🆔 Binance ID: ${user.binanceId || 'N/A'}\n` +
                           `👥 Código Referido: ${referralCode || 'N/A'}`;
        
        sendTelegramNotification(telegramMsg);
        
        alert("📩 Solicitud de recarga enviada. Un administrador la revisará pronto.");
        closeRechargeModal();
    })
    .catch(error => {
        console.error("Error al solicitar recarga:", error);
        alert("Error al enviar la solicitud de recarga: " + error.message);
    });
}

// Funciones para el panel de administración
function openAdminPanel() {
    if (isAdmin) {
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminData();
    }
}

function closeAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
}

function showAdminTab(tabName) {
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.admin-tab[onclick="showAdminTab('${tabName}')"]`).classList.add('active');
    
    document.getElementById('rechargesTab').style.display = 'none';
    document.getElementById('withdrawalsTab').style.display = 'none';
    document.getElementById('usersTab').style.display = 'none';
    
    document.getElementById(`${tabName}Tab`).style.display = 'block';
}

// Función mejorada para verificar si es admin
function checkAdminStatus(user) {
    // Lista de emails autorizados como admin (cambiar por los que necesites)
    const adminEmails = ["admin@roulette.com", "tuemail@admin.com"];
    return user && user.email && adminEmails.includes(user.email);
}

function loadAdminData() {
    // Verificar nuevamente si es admin antes de cargar datos
    const user = auth.currentUser;
    isAdmin = checkAdminStatus(user);
    
    if (!isAdmin) {
        alert("Acceso denegado: no tienes permisos de administrador");
        closeAdminPanel();
        return;
    }

    // Cargar recargas pendientes
    db.collection('rechargeRequests').where('status', '==', 'pending').get()
        .then(querySnapshot => {
            const tbody = document.getElementById('pendingRecharges');
            tbody.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = `
                    <tr>
                        <td>${data.userName || 'N/A'}</td>
                        <td>${data.userEmail}</td>
                        <td>$${data.amount.toFixed(2)}</td>
                        <td>${data.binanceId || 'N/A'}</td>
                        <td>${new Date(data.timestamp?.toDate()).toLocaleString()}</td>
                        <td>
                            <button class="admin-action-btn approve-btn" onclick="processRecharge('${doc.id}', 'approved')">Aprobar</button>
                            <button class="admin-action-btn reject-btn" onclick="processRecharge('${doc.id}', 'rejected')">Rechazar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error("Error cargando recargas:", error);
            alert("Error al cargar recargas pendientes");
        });
    
    // Cargar retiros pendientes
    db.collection('withdrawalRequests').where('status', '==', 'pending').get()
        .then(querySnapshot => {
            const tbody = document.getElementById('pendingWithdrawals');
            tbody.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = `
                    <tr>
                        <td>${data.userName || 'N/A'}</td>
                        <td>${data.userEmail}</td>
                        <td>$${data.amount.toFixed(2)}</td>
                        <td>${data.binanceId || 'N/A'}</td>
                        <td>${new Date(data.timestamp?.toDate()).toLocaleString()}</td>
                        <td>
                            <button class="admin-action-btn approve-btn" onclick="processWithdrawal('${doc.id}', 'approved')">Aprobar</button>
                            <button class="admin-action-btn reject-btn" onclick="processWithdrawal('${doc.id}', 'rejected')">Rechazar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error("Error cargando retiros:", error);
            alert("Error al cargar retiros pendientes");
        });
    
    // Cargar usuarios
    db.collection('usuarios').get()
        .then(querySnapshot => {
            const tbody = document.getElementById('usersList');
            tbody.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = `
                    <tr>
                        <td>${data.email}</td>
                        <td>$${data.saldo?.toFixed(2) || '0.00'}</td>
                        <td>$${data.totalRecharges?.toFixed(2) || '0.00'}</td>
                        <td>$${data.totalWithdrawals?.toFixed(2) || '0.00'}</td>
                        <td>${data.referralCount || 0}</td>
                        <td>${new Date(data.createdAt?.toDate()).toLocaleDateString()}</td>
                        <td>${data.binanceId || 'N/A'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error("Error cargando usuarios:", error);
            alert("Error al cargar lista de usuarios");
        });
}

// Función mejorada para procesar recargas
async function processRecharge(requestId, action) {
    try {
        // Verificar nuevamente si es admin
        const user = auth.currentUser;
        isAdmin = checkAdminStatus(user);
        
        if (!isAdmin) {
            alert("Acción denegada: no tienes permisos de administrador");
            return;
        }

        const doc = await db.collection('rechargeRequests').doc(requestId).get();
        const data = doc.data();
        
        if (action === 'approved') {
            // Actualizar saldo del usuario
            await db.collection('usuarios').doc(data.userId).update({
                saldo: firebase.firestore.FieldValue.increment(data.amount),
                totalRecharges: firebase.firestore.FieldValue.increment(data.amount)
            });
            
            // Marcar recarga como aprobada
            await db.collection('rechargeRequests').doc(requestId).update({
                status: 'approved',
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: user.email
            });
            
            // Notificación a Telegram
            const telegramMsg = `✅ <b>RECARGA APROBADA</b>\n\n` +
                               `👤 Usuario: ${data.userEmail}\n` +
                               `💰 Monto: $${data.amount.toFixed(2)} USD\n` +
                               `🆔 Binance ID: ${data.binanceId || 'N/A'}\n` +
                               `🔄 Procesado por: ${user.email}`;
            
            sendTelegramNotification(telegramMsg);
            
            alert("Recarga aprobada con éxito");
        } else {
            // Marcar recarga como rechazada
            await db.collection('rechargeRequests').doc(requestId).update({
                status: 'rejected',
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: user.email
            });
            
            // Notificación a Telegram
            const telegramMsg = `❌ <b>RECARGA RECHAZADA</b>\n\n` +
                               `👤 Usuario: ${data.userEmail}\n` +
                               `💰 Monto: $${data.amount.toFixed(2)} USD\n` +
                               `🆔 Binance ID: ${data.binanceId || 'N/A'}\n` +
                               `🔄 Procesado por: ${user.email}`;
            
            sendTelegramNotification(telegramMsg);
            
            alert("Recarga rechazada");
        }
        
        // Recargar datos
        loadAdminData();
    } catch (error) {
        console.error("Error procesando recarga:", error);
        alert("Error al procesar la recarga: " + error.message);
    }
}

// Función mejorada para procesar retiros
async function processWithdrawal(requestId, action) {
    try {
        // Verificar nuevamente si es admin
        const user = auth.currentUser;
        isAdmin = checkAdminStatus(user);
        
        if (!isAdmin) {
            alert("Acción denegada: no tienes permisos de administrador");
            return;
        }

        const doc = await db.collection('withdrawalRequests').doc(requestId).get();
        const data = doc.data();
        
        if (action === 'approved') {
            // Verificar que el usuario tenga saldo suficiente
            const userDoc = await db.collection('usuarios').doc(data.userId).get();
            const userData = userDoc.data();
            
            if (userData.saldo < data.amount) {
                alert("El usuario no tiene suficiente saldo para este retiro");
                return;
            }

            // Actualizar saldo del usuario
            await db.collection('usuarios').doc(data.userId).update({
                saldo: firebase.firestore.FieldValue.increment(-data.amount),
                totalWithdrawals: firebase.firestore.FieldValue.increment(data.amount)
            });
            
            // Marcar retiro como aprobado
            await db.collection('withdrawalRequests').doc(requestId).update({
                status: 'approved',
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: user.email
            });
            
            // Notificación a Telegram
            const telegramMsg = `✅ <b>RETIRO APROBADO</b>\n\n` +
                               `👤 Usuario: ${data.userEmail}\n` +
                               `💰 Monto: $${data.amount.toFixed(2)} USD\n` +
                               `🆔 Binance ID: ${data.binanceId || 'N/A'}\n` +
                               `🔄 Procesado por: ${user.email}`;
            
            sendTelegramNotification(telegramMsg);
            
            alert("Retiro aprobado con éxito");
        } else {
            // Marcar retiro como rechazado
            await db.collection('withdrawalRequests').doc(requestId).update({
                status: 'rejected',
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: user.email
            });
            
            // Notificación a Telegram
            const telegramMsg = `❌ <b>RETIRO RECHAZADO</b>\n\n` +
                               `👤 Usuario: ${data.userEmail}\n` +
                               `💰 Monto: $${data.amount.toFixed(2)} USD\n` +
                               `🆔 Binance ID: ${data.binanceId || 'N/A'}\n` +
                               `🔄 Procesado por: ${user.email}`;
            
            sendTelegramNotification(telegramMsg);
            
            alert("Retiro rechazado");
        }
        
        // Recargar datos
        loadAdminData();
        
        // Si el usuario está viendo sus retiros, actualizarlos
        if (userId === data.userId) {
            loadMyWithdrawals();
        }
    } catch (error) {
        console.error("Error procesando retiro:", error);
        alert("Error al procesar el retiro: " + error.message);
    }
}

// Funciones para el formulario de retiro
function openWithdrawForm() {
    if (totalGanado < 30) {
        document.getElementById('withdrawMessage').textContent = "❌ Necesitas al menos $30 USD para solicitar un retiro.";
        document.getElementById('withdrawMessage').style.color = "#e74c3c";
    } else {
        document.getElementById('withdrawMessage').textContent = `✅ Puedes retirar hasta $${totalGanado.toFixed(2)} USD.`;
        document.getElementById('withdrawMessage').style.color = "#27ae60";
        document.getElementById('withdrawAmount').max = totalGanado;
        document.getElementById('withdrawAmount').value = totalGanado.toFixed(2);
    }
    
    document.getElementById('withdrawForm').classList.remove('hidden');
}

function closeWithdrawForm() {
    document.getElementById('withdrawForm').classList.add('hidden');
}

async function requestWithdrawal() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    
    if (!amount || amount < 30 || amount > totalGanado) {
        alert("Por favor ingresa un monto válido entre $30 y $" + totalGanado.toFixed(2));
        return;
    }
    
    const user = auth.currentUser;
    
    try {
        // Primero obtenemos el ID de Binance del usuario
        const doc = await db.collection('usuarios').doc(user.uid).get();
        
        if (!doc.exists) {
            throw new Error("Usuario no encontrado");
        }
        
        const userData = doc.data();
        const binanceId = userData.binanceId;
        
        if (!binanceId) {
            throw new Error("No se encontró ID de Binance para este usuario");
        }
        
        // Creamos la solicitud de retiro
        await db.collection('withdrawalRequests').add({
            userId: user.uid,
            userName: user.displayName || user.email.split('@')[0],
            userEmail: user.email,
            binanceId: binanceId,
            amount: amount,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Notificación a Telegram
        const telegramMsg = `🆕 <b>NUEVA SOLICITUD DE RETIRO</b>\n\n` +
                           `👤 Usuario: ${user.email}\n` +
                           `💰 Monto: $${amount.toFixed(2)} USD\n` +
                           `🆔 Binance ID: ${binanceId}\n` +
                           `👥 Código Referido: ${referralCode || 'N/A'}`;
        
        sendTelegramNotification(telegramMsg);
        
        alert("Solicitud de retiro enviada. Será procesada por un administrador.");
        closeWithdrawForm();
        
        // Actualizar la lista de mis retiros
        loadMyWithdrawals();
    } catch (error) {
        console.error("Error solicitando retiro:", error);
        alert("Error al enviar la solicitud de retiro: " + error.message);
    }
}

// Alternar entre login y registro
function toggleRegister() {
    registering = !registering;
    const binanceInput = document.getElementById('binanceIdRegister');
    const referralInput = document.getElementById('referralCode');
    const loginBtn = document.querySelector('.auth-form button[onclick="login()"]');
    const registerBtn = document.querySelector('.auth-form button[onclick="toggleRegister()"]');
    
    if (registering) {
        binanceInput.classList.remove('hidden');
        referralInput.classList.remove('hidden');
        loginBtn.textContent = 'Cancelar';
        registerBtn.textContent = 'Registrarse';
        registerBtn.setAttribute('onclick', 'signup()');
    } else {
        binanceInput.classList.add('hidden');
        referralInput.classList.add('hidden');
        loginBtn.textContent = 'Iniciar Sesión';
        registerBtn.textContent = 'Registrarse';
        registerBtn.setAttribute('onclick', 'toggleRegister()');
    }
}

// Función para generar un código de referido único
function generateReferralCode(userId, email) {
    // Usamos las primeras 4 letras del email + últimos 4 dígitos del userId
    const emailPart = email.split('@')[0].substring(0, 4).toUpperCase();
    const idPart = userId.substring(userId.length - 4);
    return emailPart + idPart;
}

// Función para cargar datos de referidos
function loadReferralData() {
    if (!userId) return;
    
    // Obtener datos del usuario
    db.collection('usuarios').doc(userId).get().then(doc => {
        if (doc.exists) {
            const userData = doc.data();
            referralCode = userData.referralCode || generateReferralCode(userId, userData.email);
            referralLink = window.location.href.split('?')[0] + '?ref=' + referralCode;
            
            // Mostrar enlace de referido
            document.getElementById('referralLink').textContent = referralLink;
            
            // Actualizar estadísticas
            document.getElementById('totalReferrals').textContent = userData.referralCount || 0;
            document.getElementById('activeReferrals').textContent = userData.activeReferrals || 0;
            document.getElementById('referralEarnings').textContent = '$' + (userData.referralEarnings || 0).toFixed(2);
            
            // Si es admin, no cargar lista de referidos
            if (isAdmin) return;
            
            // Cargar lista de referidos
            if (userData.referralCount > 0) {
                db.collection('usuarios')
                    .where('referredBy', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .get()
                    .then(querySnapshot => {
                        const referralList = document.getElementById('referralList');
                        referralList.innerHTML = '';
                        
                        if (querySnapshot.empty) {
                            referralList.innerHTML = '<div class="empty-message">No tienes referidos aún</div>';
                            return;
                        }
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const item = document.createElement('div');
                            item.className = 'referral-item';
                            item.innerHTML = `
                                <div>${data.email}</div>
                                <div>${new Date(data.createdAt?.toDate()).toLocaleDateString()}</div>
                            `;
                            referralList.appendChild(item);
                        });
                    });
            }
        }
    });
}

// Función para copiar el enlace de referido
function copyReferralLink() {
    navigator.clipboard.writeText(referralLink).then(() => {
        alert('¡Enlace copiado al portapapeles!');
    }).catch(err => {
        console.error('Error al copiar: ', err);
        // Fallback para navegadores antiguos
        const tempInput = document.createElement('input');
        tempInput.value = referralLink;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        alert('¡Enlace copiado al portapapeles!');
    });
}

// Funciones para compartir
function shareViaWhatsApp() {
    const message = `¡Únete a la Ruleta Rusa de Premios y gana dinero real! Usa mi código ${referralCode} al registrarte y obtén $1 USD de bono. ${referralLink}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
}

function shareViaTelegram() {
    const message = `¡Únete a la Ruleta Rusa de Premios y gana dinero real! Usa mi código ${referralCode} al registrarte y obtén $1 USD de bono. ${referralLink}`;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(message)}`, '_blank');
}

function shareViaFacebook() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}`, '_blank');
}

// Función para verificar si hay un código de referido en la URL
function checkForReferralCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    
    if (refCode) {
        document.getElementById('referralCode').value = refCode;
    }
}

// Función para registrarse con manejo de referidos
function signup() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const binanceId = document.getElementById('binanceIdRegister').value;
    const referralCodeInput = document.getElementById('referralCode').value;
    
    if (!binanceId) {
        alert("Por favor ingresa tu ID de Binance");
        return;
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
            const user = auth.currentUser;
            const userData = {
                email: user.email,
                binanceId: binanceId,
                saldo: 0,
                totalRecharges: 0,
                totalWithdrawals: 0,
                referralCode: generateReferralCode(user.uid, user.email),
                referralCount: 0,
                activeReferrals: 0,
                referralEarnings: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Si hay código de referido, buscar al referidor
            if (referralCodeInput) {
                return db.collection('usuarios')
                    .where('referralCode', '==', referralCodeInput)
                    .limit(1)
                    .get()
                    .then(querySnapshot => {
                        if (!querySnapshot.empty) {
                            const referrerDoc = querySnapshot.docs[0];
                            const referrerData = referrerDoc.data();
                            const referrerId = referrerDoc.id;
                            
                            // Actualizar datos del referidor
                            db.collection('usuarios').doc(referrerId).update({
                                referralCount: firebase.firestore.FieldValue.increment(1),
                                activeReferrals: firebase.firestore.FieldValue.increment(1),
                                referralEarnings: firebase.firestore.FieldValue.increment(1),
                                saldo: firebase.firestore.FieldValue.increment(1)
                            });
                            
                            // Agregar referencia al usuario nuevo
                            userData.referredBy = referrerId;
                            userData.saldo = 1; // Bono por referido
                            
                            // Notificación al referidor
                            sendTelegramNotification(
                                `🎉 <b>NUEVO REFERIDO REGISTRADO</b>\n\n` +
                                `👤 Usuario: ${email}\n` +
                                `🆔 Tu código: ${referralCodeInput}\n` +
                                `💰 Has ganado $1 USD`
                            );
                        }
                        
                        return db.collection('usuarios').doc(user.uid).set(userData);
                    });
            } else {
                return db.collection('usuarios').doc(user.uid).set(userData);
            }
        })
        .then(() => {
            // Notificación a Telegram
            let telegramMsg = `🆕 <b>NUEVO USUARIO REGISTRADO</b>\n\n` +
                           `📧 Email: ${email}\n` +
                           `🆔 Binance ID: ${binanceId}`;
            
            if (referralCodeInput) {
                telegramMsg += `\n👥 Referido por: ${referralCodeInput}`;
            }
            
            sendTelegramNotification(telegramMsg);
            
            toggleRegister();
        })
        .catch((error) => {
            alert("Error al registrarse: " + error.message);
        });
}

// Escuchar cambios de autenticación
auth.onAuthStateChanged((user) => {
    if (user) {
        // Usuario autenticado
        userId = user.uid;
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('gameContainer').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('userEmail').textContent = user.email;
        
        // Verificar si es admin
        isAdmin = checkAdminStatus(user);
        if (isAdmin) {
            document.getElementById('adminBtn').classList.remove('hidden');
        } else {
            document.getElementById('adminBtn').classList.add('hidden');
        }
        
        // Cargar saldo del usuario
        cargarSaldoUsuario();
        // Cargar datos de referidos
        loadReferralData();
    } else {
        // No autenticado
        userId = null;
        isAdmin = false;
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('adminBtn').classList.add('hidden');
        // Verificar código de referido en la URL
        checkForReferralCode();
    }
});

// Función para iniciar sesión
function login() {
    if (registering) {
        toggleRegister();
        return;
    }
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            // Inicio de sesión exitoso
        })
        .catch((error) => {
            alert("Error al iniciar sesión: " + error.message);
        });
}

// Función para cerrar sesión
function logout() {
    auth.signOut()
        .then(() => {
            // Sesión cerrada correctamente
        })
        .catch((error) => {
            alert("Error al cerrar sesión: " + error.message);
        });
}

// Función para cargar el saldo del usuario
function cargarSaldoUsuario() {
    if (!userId) return;
    
    db.collection('usuarios').doc(userId).get()
        .then((doc) => {
            if (doc.exists) {
                totalGanado = doc.data().saldo || 0;
                actualizarTotal();
            } else {
                // Si no existe el documento, crearlo
                const user = auth.currentUser;
                db.collection('usuarios').doc(userId).set({
                    email: user.email,
                    saldo: 5.00, // Saldo inicial
                    totalRecharges: 0,
                    totalWithdrawals: 0,
                    referralCode: generateReferralCode(userId, user.email),
                    referralCount: 0,
                    activeReferrals: 0,
                    referralEarnings: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                totalGanado = 5.00;
                actualizarTotal();
            }
        })
        .catch((error) => {
            console.error("Error al cargar saldo:", error);
        });
}

// Función para actualizar el saldo en Firestore
function actualizarSaldoEnFirebase() {
    if (!userId) return;
    
    db.collection('usuarios').doc(userId).update({
        saldo: totalGanado,
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    })
    .catch((error) => {
        console.error("Error al actualizar saldo:", error);
    });
}

// Funciones del juego
function dibujarRuleta() {
    ctx.clearRect(0, 0, 400, 400);
    for (let i = 0; i < premios.length; i++) {
        const angulo = anguloInicio + i * arc;
        ctx.beginPath();
        ctx.fillStyle = colores[i];
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 200, angulo, angulo + arc);
        ctx.fill();
        ctx.save();
        ctx.translate(200, 200);
        ctx.rotate(angulo + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "white";
        ctx.font = "bold 15px Arial";
        ctx.fillText(premios[i], 180, 5);
        ctx.restore();
    }
    ctx.beginPath();
    ctx.moveTo(200, 0);
    ctx.lineTo(190, 20);
    ctx.lineTo(210, 20);
    ctx.closePath();
    ctx.fillStyle = "white";
    ctx.fill();
}

function girar() {
    if (girando) return;
    if (totalGanado < 1) {
        document.getElementById("resultado").textContent = "⚠ No tienes suficiente saldo para girar.";
        return;
    }
    totalGanado -= 1;
    actualizarTotal();
    actualizarSaldoEnFirebase();
    girando = true;
    velocidad = Math.random() * 0.3 + 0.4;
    animarGiro();
}

function animarGiro() {
    if (!girando) return;
    velocidad *= frenado;
    if (velocidad < 0.002) {
        girando = false;
        velocidad = 0;
        determinarPremio();
        return;
    }
    anguloInicio += velocidad;
    dibujarRuleta();
    requestAnimationFrame(animarGiro);
}

function determinarPremio() {
    const grados = anguloInicio * 180 / Math.PI + 90;
    const anguloFinal = (360 - (grados % 360)) % 360;
    const indice = Math.floor(anguloFinal / (360 / premios.length));
    const premio = premios[indice];

    if (premio === "Nada") {
        document.getElementById("resultado").textContent = "💀 Nada de nada...";
    } else {
        document.getElementById("resultado").textContent = `💰 Premio: ${premio}`;
        totalGanado += parseFloat(premio.replace("$", ""));
    }

    actualizarTotal();
    actualizarSaldoEnFirebase();
}

function actualizarTotal() {
    document.getElementById("total").textContent = 
        `💵 Total ganado: $${totalGanado.toFixed(2)} USD`;
}

// Inicializar ruleta y panel lateral
dibujarRuleta();
generateRandomWithdrawals();
generateRandomRecharges();
checkForReferralCode();

// Actualizar el panel lateral cada 30 segundos
setInterval(() => {
    generateRandomWithdrawals();
    generateRandomRecharges();
}, 30000);

// Cerrar modal al hacer clic fuera del contenido
window.onclick = function(event) {
    const modal = document.getElementById('rulesModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
    
    const adminPanel = document.getElementById('adminPanel');
    if (event.target == adminPanel) {
        adminPanel.style.display = 'none';
    }
    
    const rechargeModal = document.getElementById('rechargeModal');
    if (event.target == rechargeModal) {
        rechargeModal.style.display = 'none';
    }
    
    const withdrawForm = document.getElementById('withdrawForm');
    if (event.target == withdrawForm) {
        withdrawForm.classList.add('hidden');
    }
}
</script>

</body>
</html>

</body>

</html>






